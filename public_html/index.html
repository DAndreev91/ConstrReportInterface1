<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script type="text/javascript" src="bower_components/jquery/dist/jquery.js"></script>
        <link href="bower_components/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
        <script type="text/javascript" src="bower_components/bootstrap/dist/js/bootstrap.js"></script>
        <script type="text/javascript">
            var tepList = [];
            var docType = 123123;
            var docTypeBack;
            var tepId;
            var finalVal;
            var id = 123;
            $(document).ready(function() {
                
                $.ajax({
                    url: "dfile.pget_doctep",
                    data: { "oid": id,
                            "tid": 305855907,
                            "valLen": 32000,
                            "return_type": 2},
                    success: function(html) {
                        $("#ParentDocType").val(html);
                    }
                });
                
                $.ajax({
                    url: "dfile.pget_doctep",
                    data: { "oid": id,
                            "tid": 305854177,
                            "valLen": 32000,
                            "return_type": 2},
                    success: function(html) {
                        $("#ReportName").val(html);
                    }
                });
                
                //docType = $("#ParentDocType").val();
                console.log(docType);
                
                $.ajax({
                    url: "dfile.getDocTypeForConstrRep",
                    data: { "did": id },
                    success: function(html) {
                        $("#div1 table tbody").append(html);
                    }
                });
                
                $.ajax({
                    url: "dfile.getTepsForConstrRep",
                    data: { "did": id,
                            "str": docType},
                    success: function(html) {
                        $("#div2 table tbody").append(html);
                    }
                });
                
                $.ajax({
                    url: "dfile.getTepsWithinConstrRep",
                    data: { "did": id },
                    success: function(html) {
                        $("#div3 table tbody").append(html);
                    }
                });
                
                $(document).on("dblclick", "#div1 tr", function() {
                    docTypeBack = docType;
                    if (docType == null) {
                        docType = $(this).children("td").data("value");
                        $("#ParentDocType").val(docType);
                    } else {
                        docType = docType + "&" + $(this).children("td").data("value");
                    }
                    $("#div1 .page-lock, #div2 .page-lock").toggle(50).delay(1000);
                    $("#div1 .loader, #div2 .loader").toggle(200).delay(1000);
                    $.ajax({
                        url: "dfile.getDocTypeForConstrRep",
                        data: {"did" : id,
                               "str": docType},
                        success: function(html) {
                            $("#div1 table tbody").html(html);
                        }
                    });
                    $.ajax({
                        url: "dfile.getTepsForConstrRep",
                        data: {"did" : id,
                               "str": docType},
                        success: function(html) {
                            $("#div2 table tbody").html(html);
                        }
                    });
                    $("#div1 .page-lock,#div2 .page-lock").toggle(50).delay(1000);
                    $("#div1 .loader, #div2 .loader").toggle(200); 
                    var val = $(this).children("td").data("value");
                    var finVal;
                    if (val.toString().indexOf("_") >= 0) {
                        finVal = val;
                    } else {
                        finVal = docType;
                    };
                    $.ajax({
                        url: "dfile.getDocTypeForTeps",
                        data: {
                            "dtid_str": finVal
                        },
                        success: function(html) {
                            $("#div5").html(html);
                        }
                    });
                });
                
                $(document).on("dblclick", "#div2 tr", function() {
                    $(this).fadeOut(500);
                    tepId = $(this).children("td").data("value");
                    finalVal = "{" + docType + "_" + tepId + "}";
                    var clObj = $(this).clone();
                    $(clObj).children("td").attr("data-value", finalVal);
                    $("#div3 table").append($("<tr>"+ $(clObj).html() + "</tr>").hide().fadeIn(500));
                });
                
                $(document).on("dblclick", "#div3 tr", function() {
                    $(this).fadeOut(500);
                    var indx = tepList.indexOf($(this).children("td").data("value"));
                    tepList.splice(indx, 1);
                    var val = $(this).children("td").data("value");
                    val = val.substring(val.indexOf("_"));
                    val = val.replace("}", "").replace("_", "");
                    var clObj = $(this).clone();
                    $(clObj).children("td").attr("data-value", val);
                    $("#div2 table").append($("<tr>"+ $(clObj).html() + "</tr>").hide().fadeIn(500));
                });
                
                $(document).on("click", "#div4 #sub", function() {
                    for (var i in tepList) {
                        console.log(i + " " + tepList[i]);
                    };
                    $("#div3 tr").children("td").each( function() {
                        tepList.push($(this).data("value"));
                    });
                    $.ajax({
                        url: "dfile.saveConstrRepTeps",
                        data: {
                            tepList: tepList
                        },
                        success: function(html) {
                            alert(html);
                        }
                    });
                });
                
                $(document).on("click", "#div1 #back", function() {
                    if (docType.toString().indexOf("&") < 0 ) {
                        return;
                    }
                    docType = docType.toString().slice(0,docType.toString().lastIndexOf("&"));
                    console.log(docType);
                    $("#div1 .page-lock, #div2 .page-lock").toggle(50).delay(1000);
                    $("#div1 .loader, #div2 .loader").toggle(200).delay(1000);
                    $.ajax({
                        url: "dfile.getDocTypeForConstrRep",
                        data: {"did" : id,
                               "str": docType},
                        success: function(html) {
                            $("#div1 table tbody").html(html);
                        }
                    });
                    $.ajax({
                        url: "dfile.getTepsForConstrRep",
                        data: {"did" : id,
                               "str": docType},
                        success: function(html) {
                            $("#div2 table tbody").html(html);
                        }
                    });
                    $("#div1 .page-lock,#div2 .page-lock").toggle(50).delay(1000);
                    $("#div1 .loader, #div2 .loader").toggle(200); 
                });
                
                $(document).on("click", "tr", function() {
                    var val = $(this).children("td").data("value");
                    console.log("val " + val);
                    var finVal;
                    if (val.toString().indexOf("_") >= 0) {
                        finVal = val;
                    } else {
                        finVal = docType;
                    };
                    console.log("finVal: " + finVal);
                    $.ajax({
                        url: "dfile.getDocTypeForTeps",
                        data: {
                            "dtid_str": finVal
                        },
                        success: function(html) {
                            $("#div5").html(html);
                        }
                    });
                });
            });
        </script>
        <style type="text/css">
            #div1 {
                position: absolute;
                left: 10%;
                top: 10%;
                width: 30%;
                height:40%;
                overflow-y:scroll;
            }
            
            #div2 {
                position: absolute;
                right: 10%;
                top: 10%;
                width: 30%;
                height:40%;
                overflow-y:scroll;
            }
            
            #div3 {
                position: absolute;
                right: 10%;
                top: 60%;
                width: 30%;
                max-height:40%;
                overflow-y:scroll;
            }
            
            #div4 {
                position: absolute;
                right: 48%;
                top: 70%;
                width: 4%;
                max-height:40%;
            }
            
            #div5 {
                position: absolute;
                left: 42%;
                top: 25%;
                width: 16%;
                max-height:40%;
                text-align: center;
            }
            
            #back {
                position: fixed;
            }
            
            form {
                position: absolute;
                left: 10%;
                top: 55%;
                width: 30%;
                max-height:40%;
            }
            
            #div1 .loader {
                position: fixed;
                left: 26%;
                top: 27%;
                border: 16px solid #f3f3f3; /* Light grey */
                border-top: 16px solid #3498aa; /* Blue */
                border-radius: 50%;
                width: 2%;
                height: 4%;
                animation: spin 1.5s ease infinite;
                display: none;
                z-index: 10;
            }
            
            #div2 .loader {
                position: fixed;
                right: 26%;
                top: 27%;
                border: 16px solid #f3f3f3; /* Light grey */
                border-top: 16px solid #3498aa; /* Blue */
                border-radius: 50%;
                width: 2%;
                height: 4%;
                animation: spin 1.5s ease infinite;
                display: none;
                z-index: 10;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg)}
                100% { transform: rotate(360deg)}
            }
            
            .page-lock {
                position: absolute;
                left: 0;
                top: 0;
                right: 0;
                bottom: 0;
                background: #AAA;
                z-index: 5;
                opacity: 0.5;
                width: 100%;
                height: 100%;
                display: none;
            }
            
            tr {
                cursor: pointer;
            }
            
        </style>
    </head>
    <body>
        
        
        
        <div id="div1">
            <div class="col-md-2">
                <button type="button" class="btn btn-default btn-lg" id="back">
                    <span class="glyphicon glyphicon-chevron-left"></span>
                </button>
            </div>
            <div class="col-md-10">
                <div class="page-lock"></div>
                <div class="loader"></div>
                <table class="table table-hover table-responsive" id="dttable">
                    <tbody>
                        <tr>
                            <td>OKS</td>
                        </tr>
                        <tr>
                            <td>AGR</td>
                        </tr>
                        <tr>
                            <td>MGE</td>
                        </tr>
                        <tr>
                            <td>ZOS</td>
                        </tr>
                        <tr>
                            <td data-value="123">PPT</td>
                        </tr>
                        <tr>
                            <td data-value="123">PPT</td>
                        </tr>
                        <tr>
                            <td data-value="123">PPT</td>
                        </tr>
                        <tr>
                            <td data-value="123">PPT</td>
                        </tr>
                        <tr>
                            <td data-value="123">PPT</td>
                        </tr>
                        <tr>
                            <td data-value="123">PPT</td>
                        </tr>
                        <tr>
                            <td data-value="123">PPT</td>
                        </tr>
                        <tr>
                            <td data-value="123">PPT</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        
        </div>
        
        <form role="form">
            <div class="form-group">
              <label for="ReportName">Название отчета</label>
              <input type="text" class="form-control" id="ReportName" placeholder="Введите название отчета">
            </div>
            <div class="form-group">
              <label for="ParentDocType">Главный тип</label>
              <input type="text" class="form-control" id="ParentDocType" placeholder="Укажите тип главного документа/объекта">
            </div>
        </form>

        
        <div id="div2">
            <div class="col-md-10">
                <div class="page-lock"></div>
                <div class="loader"></div>
                <table class="table table-hover table-responsive" id="dttable">
                    <tbody>
                        <tr>
                            <td data-value="1">OKS</td>
                        </tr>
                        <tr>
                            <td data-value="22">AGR</td>
                        </tr>
                        <tr>
                            <td data-value="333">MGE</td>
                        </tr>
                        <tr>
                            <td data-value="321">ZOS</td>
                        </tr>
                        <tr>
                            <td data-value="56">PPT</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="div3">
            <table class="table table-hover table-responsive" id="dttable">
                <tbody>
                </tbody>
            </table>
        </div>
        
        <div id="div4">
            <button type="button" class="btn btn-primary" id="sub">Submit</button>
        </div>
        
        <div id="div5">
            <p>it's a small text</p>
        </div>
    
    </body>
</html>
